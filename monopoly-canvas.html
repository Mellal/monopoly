    <!DOCTYPE html>
    <html>
	 <head>
	   <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
	   <title>Monopoly</title>
	   <link type="text/css" href="css/sunny/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
	   <script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
	   <script type="text/javascript" src="js/jquery-ui-1.7.2.custom.min.js"></script>
	   <script type="text/javascript" src="monopoly.js"></script>
	   <style>
		.hypotheque {
            background-color: lightgrey;
            color:black;
		}		
	   </style>
		<link rel="stylesheet" type="text/css" href="style.css"/>
	  
		<body>
		
		<table><tr><td>
		<div style="width:1000px;height:1000px" id="plateau">
		<canvas id="canvas" width="870" height="870"></canvas>
		<canvas id="canvas_rt" width="870" height="870" style="top:0px;left:0px;position:absolute"></canvas>
		
		</div>
		</td>
		<td style="vertical-align:top">
	    
	   <div id="idDebug">
	   case : <input type="text" size="3" id="nb"/><input type="button" onclick="joueurCourant.joueDes(parseInt($('#nb').val()))" value="click"/><br/>
	   Goto : <input type="text" size="3" id="ide"/><input type="text" size="3" id="idp"/><input type="button" onclick="joueurCourant.pion.goto($('#ide').val(),$('#idp').val(),doActions)" value="goto"/><br/>
	   
	   
	   maison constructible : <input type="button" value="Chercher" onclick="construireMaisons()"/><br/>
	   Tableau de bord : <input type="button" value="Ouvrir" onclick="$('#housesPanel').dialog('open')"/><br/>
	   </div>
	   <div id="informations"></div>
	 
	   </td></tr></table>
	 
	   <div id="fiche" style="background-color:white;font-size:12px">
		<table style="width:250px;">
		  <tr><td></td><td>€</td></tr>
		  <tr><td>ACHAT</td><td id="achat" name="achat"></td></tr>
		  <tr><td>LOYER terrain nu</td><td id="loyer0"></td></tr>
		  <tr class="maison"><td> - 1 maison</td><td id="loyer1" name="loyer1"></td></tr>
		  <tr class="maison"><td> - 2 maisons</td><td id="loyer2" name="loyer2"></td></tr>
		  <tr class="maison"><td> - 3 maisons</td><td id="loyer3" name="loyer3"></td></tr>
		  <tr class="maison"><td> - 4 maisons</td><td id="loyer4" name="loyer4"></td></tr>
		  <tr class="maison"><td> - Hotel</td><td id="loyer5" name="loyer5"></td></tr>
		</table>
		<hr/>
		<div class="infos-group">
	   Si un joueur possède <span style="font-weight:bold">TOUS</span> les terrains d'un Groupe de Couleur quelconque,
	   le loyer des terrains nus de ce groupe est doublé.
		</div>
		<hr/>
		<div>
		Prix des Maisons  F <span id="prixMaison" name="prixMaison"></span> chacune<br/>
		Prix d'un Hôtel&nbsp; F <span id="prixHotel" name="prixMaison"></span> chacun<br/>
		</div>
		Valeur hypotécaire : Frs <span id="hypotheque" name="hypotheque"></span>
		
	   </div>
	   
	   <div id="ficheCompagnie" style="background-color:white">
		<br/>
		Si l'on possède UNE carte de compagnie de Service Public, le loyer est 400 fois le montant indiqué par les dés.<br/><br/>
		Si l'on possède les DEUX cartes de compagnies de Service Public, le loyer est MILLE fois le montant indiqué par les dés.<br/><br/>
		Valeur hypotécaire : Frs 7.500
	   </div>
	   
	   <div style="position:absolute;top:210px;left:320px;padding:5px;width:200px;height:80px;" class="ui-corner-all" id="informationsCentrale"></div>
	   <button style="position:absolute;top:260px;left:220px;" onclick="lancerAnimerDes()" id="idLancerDes">Lancez</button>
	   <div style="position:absolute;top:300px;left:200px;border:solid 1px black;border-radius:10px;width:230px;padding:5px" id="idMontantParc">
		Parc Gratuit : Frs <span></span>
	   </div>
	   
	   <div id="achatMaisons" style="background-color:white;"></div>
	   <div id="message" style="display:none;background-color:white"></div>
	 
	 	<div style="display:none" id="housesPanel">
	 	<div style="width:50%;height:calc(100% - 40px);background-color:lightblue;float:left">
	 		<div class="title-dialog">Hypotheque</div>
			<div id="idTerrainsHypotheques">
				Terrains hypothéqués<br/>
				<div>
				
				</div>
			</div>
			<hr/>
			<div id="idTerrains">
				Terrains hypothécables<br/>
				<select></select>
				<button id="idHypothequeAction">Hypothéquer</button>
				<div id="toHypotheque"></div>
			</div>			
	 	</div>
	 	<div style="width:50%;height:calc(100% - 40px);background-color:lightgreen;float:right">
	 		<div class="title-dialog">Constructions</div>
			<div id="idTerrainsConstructibles" class="constructions" style="padding-left: 10px"></div>
			<hr style="margin-right:10px;width:150px;float:right;"/>
			<div style="clear:both"></div>
			<div style="margin-right:40px;float:right" id="coutAchats">
			 <img src="maison.png" style="width:15px;"/> x <span name="nbMaison">0</span>
			 <img src="hotel.png" style="width:15px;"/> x <span name="nbHotel">0</span>
			 <span name="cout" style="margin-left: 10px"></span> <span class="currency-value"></span>
			</div>
	 	</div>
		<div id="idTest" style="clear:both;width:100%;height:40px">
		  <table style="height:100%;width:100%;border:0;border-collapse: collapse"><tr>
		  <td style="width:37%;height:100%;background-color: lightblue;border-top:solid 1px lightblue;"></td>
		  <td style="width:26%;border:solid 1px black;padding:5px">
		    Resultat : <span id="idCoutTotal"></span><br/>
		    Porte-monnaie : <span id="idArgentRestant"></span>
		  </td>
		  <td style="width:37%;background-color: lightgreen;border-top:solid 1px lightgreen;"></td>
		  </tr></table>
		</div>
		
	 	</div>
	 
	 
	 
	   <script language="javascript">
		// On detecte le type de donnees a charger
		var plateau = "data-monopoly.json";
		if (location.href.indexOf("plateau=")!=-1) {
		  plateau = "data-monopoly-" + location.href.substring(location.href.indexOf("plateau=")+8) + ".json";
		}
		$(function(){
		  init(plateau);
		});
		
		var maisonsToHypo = [];
		var maisonsToLever = [];
		var cout = 0;
		var totalRestant = 0;
		
		
		var GestionTerrains = {
			maisonsToLever:[],
			changesConstructions:[],
			cout:0,
			totalRestant:0,
			divCout:$('#idCoutTotal'),
			divArgentRestant:$('#idArgentRestant'),
			/* Remet a 0 le panneau */
			reset:function() {
			  this.Hypotheque.reset();
			  this.LeverHypotheque.reset();
			  this.Constructions.reset();
			  this.cout=0;
			  $('#coutAchats > span[name]').text(0);
			  $('.currency-value').text(CURRENCY);
			  this.update();		  
			},
			/* Charge les informations */
			load:function(){
				this.Hypotheque.load();
				this.LeverHypotheque.load();
				this.Constructions.load();
			},
			/* Modifie le cout global */
			addCout:function(montant){
				this.cout+=montant;
				this.update();
			},
			/* Mets a jour le panneau */
			update:function(){
			 // On mets a jour les maisons, si on ajoute, on ne peut pas hypothequer
			  this.Hypotheque.update();			  
			  var totals = this.Constructions.update();

			  this.divCout.text((this.cout-totals.cout) + " " + CURRENCY);
			  this.totalRestant = joueurCourant.montant + this.cout-totals.cout;
			  this.divArgentRestant.text((this.totalRestant) + " " + CURRENCY);		  
			},
			verify:function(){
				try{
					if(this.totalRestant < 0){
						throw "Opération impossible : pas assez d'argent";
					}
					this.Constructions.verify();
				}catch(e){
					alert(e);
					return false;
				}
			}
			valider:function(){
				this.verify();
				  // On recupere les fiches et on hypotheque les biens
				  for(var id in maisonsToHypo){
					maisonsToHypo[id].hypotheque();
				  }
				  
				  // On recupere les fiches dont on leve l'hypotheque
				  for(var id in maisonsToLever){
				  	maisonsToLever[id].leveHypotheque();
				  }
				  
				  // Gestion des constructions
				  for (var achat in changesConstructions) {
					var data = changesConstructions[achat];
					data.propriete.setNbMaison(data.nbMaison);
					joueurCourant.payer(data.cout);
				  }
				  
				  $('#housesPanel').dialog('close');
			},
			/* Gere l'hypotheque de terrain */
			Hypotheque:{
				table:[],
				select:$('select','#idTerrains'),
				div:$('#toHypotheque'),
				reset:function(){
					this.table=[];
					this.select.empty();
					this.div.empty();
					$('#idHypothequeAction').unbind('click').bind('click',this.add);
				},	
				update:function(){
					$('option[data-color]',this.select).removeAttr('disabled');
					var colors = GestionTerrains.Constructibles.getGroupesConstruits();
					for (var i in colors){
						$('option[data-color="' + colors[i] +'"]',this.select).attr('disabled','disabled');
				  	});
				},			
				/* Charge les terrains hypothequables */
				load:function(){
					var proprietes = joueurCourant.findMaisonsHypothecables();
					  $(proprietes).each(function(){
						  GestionTerrains.Hypotheque.addOption(this);
					  });
				},
				addOption:function(fiche){
				   var option = $("<option data-color='" + fiche.color + "' value='" + fiche.id + "'>" + fiche.nom + " (+" + fiche.montantHypotheque + " " + CURRENCY + ")</option>");
				   option.data("fiche",fiche);			
				   this.select.append(option);
				},
				/* Ajoute une propriete aux hypotheques */
				add:function(){
					var terrain =  $('option:selected',this.div);
					var fiche = terrain.data("fiche");
					this.table[fiche.id] = fiche;
					var div = $('<div>' + fiche.nom + '</div>');
					var boutonAnnuler = $('<button style="margin-right:5px">Annuler</button>');
					var _self = this;
					boutonAnnuler.click(function(){
						_self.addOption(fiche);
						$(this).parent().remove();
						GestionTerrains.addCout(-fiche.hypotheque);
						delete _self.table[fiche.id];
					});
					div.prepend(boutonAnnuler);
					this.div.append(div)
					$('option:selected',this.select).remove();
					cout+=fiche.montantHypotheque;
					GestionTerrains.addCout(fiche.montantHypotheque);
				}
			},
			LeverHypotheque:{
				div:$('#idTerrainsHypotheques > div'),
				table:[],
				reset:function(){
					this.div.empty();
					this.table=[];
				},
				load:function(){
					var proprietes = joueurCourant.findMaisonsHypothequees();
				  $(proprietes).each(function(){
					 var fiche = this;
					 var div = $("<div>" + this.nom + "</div>");
					 var boutonLever = $('<button style="margin-right:5px">Lever</button>');
					 boutonLever.click(function(){
					 	GestionTerrains.LeverHypotheque.lever($(this),fiche);
					 });
					 div.prepend(boutonLever);
					 GestionTerrains.Hypotheque.append(div);
				  });
				},
				lever:function(input,fiche){
					input.attr('disabled','disabled');
					this.table.push(fiche);
					GestionTerrains.addCout(-Math.round(fiche.montantHypotheque*1.1));
				},
				
			},
			Constructions:{
				table:[],
				div:$('#idTerrainsConstructibles'),
				infos:$('#coutAchats'),
				/* Verifie pour la validation et renvoie une exception */
				verify:function(){
					var testGroups = [];
					$('select[data-color]',this.div).each(function(){
						var color = $(this).get(0).dataset.color;
						if (testGroups[color]==null) {
					 		testGroups[color] = {min:5,max:0};
						}
						testGroups[color].min = Math.min(testGroups[color].min,$(this).val());
						testGroups[color].max = Math.max(testGroups[color].max,$(this).val());
				  	});
				  	for (var color in testGroups) {
						if(testGroups[color].max - testGroups[color].min > 1){
					 	throw "Il faut équilibrer les maisons";  
					}
				  }
				},
				reset:function(){
					this.table = [];
					this.div.empty();
				},
				getGroupesConstruits:function(){
					var colors = [];
					$('select[data-color][value!=0]',this.div).each(function(){
						colors.push($(this).attr('data-color'));
					});
					return colors;
				},
				update:function(){
					var totals = {nbMaison:0,nbHotel:0,cout:0}
				  	for (var achat in this.table) {
						var data = this.table[achat];
						totals.cout+=data.cout;
						totals.nbMaison+=data.maison || 0;
						totals.nbHotel+=data.hotel || 0;
					}
				  	$('span[name]',this.infos).each(function(){
						$(this).text(totals[$(this).attr('name')]);
				  	});
				  	return totals;
				},
				load:function(){
					var groups = joueurCourant.findGroupes();
					var table = $('#idTerrainsConstructibles');
					for(var color in groups) {
						var divTitre = $('<div style="cursor:pointer">Groupe <span style="color:' + color + ';font-weight:bold">' + groups[color].proprietes[0].groupe + '</span></div>');
						divTitre.data("color",color.substring(1));
						divTitre.click(function(){
							var id = 'div.propriete-' + $(this).data('color');
							if($(id + ':visible',this.div).length == 0){
								$(id,this.div).slideDown();	// On ouvre
							}
							else{
								$(id,this.div).slideUp();
							}
						});			  
						this.div.append(divTitre);
						for(var index in groups[color].proprietes){
							var propriete = groups[color].proprietes[index];
							var divTerrain = $('<div class="propriete propriete-' + this.color.substring(1) + '"></div>');
							divTerrain.append('<span style="color:' + this.color + '" class="title-propriete">' + this.nom + '</span>');
							var select = $('<select data-color="' + this.color + '" class="' + ((this.nbMaison==5)?'hotel':'maison') + '"></select>');
							for (var j = 0; j <= ((false) ? this.nbMaison : 5); j++) {
								select.append("<option class=\"" + ((j==5)?"hotel":"maison") + "\" value=\"" + j + "\" " + ((this.nbMaison == j) ? "selected" : "") + ">x " + ((j==5)?1:j) + "</option>");
						 	}
						 	var _self = this;
						 	select.change(function(){
								// On verifie changement par rapport a l'origine
								if (propriete.nbMaison == $(this).val()) {
									delete _self.table[propriete.id];
								  	$('~span',this).text("");
								  	updateCout();
								  	return;
								}
								var data = ($(this).val() == 5)?{hotel:1}:{maison:$(this).val() - propriete.nbMaison};
								data.propriete = propriete;
								data.nbMaison = $(this).val();
								data.cout = ($(this).val() > propriete.nbMaison)
								  ?($(this).val()-propriete.nbMaison)*propriete.prixMaison
								  :($(this).val()-propriete.nbMaison )*propriete.prixMaison/2;
								  $(this).removeClass().addClass(($(this).val()==5)?'hotel':'maison');
								$('~span',this).text(data.cout);
								_self.table[propriete.id] = data;
								GestionTerrains.update();
						 });
						 divTerrain.append(select).append('<span></span> ' + CURRENCY);						 
						 $(this.div).append(divTerrain);
						}
					}
				}
				
			}
		}
		
		//DONE
		function reset() {
			$('.currency-value').text(CURRENCY);
		  maisonsToHypo=[];
		  maisonsToLever=[];
		  changesConstructions=[];
		  cout=0;
		  $('select','#idTerrains').empty();
		  $('#idTerrainsHypotheques > div').empty();
		  $('#idTerrainsConstructibles').empty();
		  $('#toHypotheque').empty();
		  $('#coutAchats > span[name]').text(0);
		  updateCout();		  
		}
		
		//DONE
		$('#idHypothequeAction').click(function(){
			var terrain =  $('select > option:selected','#idTerrains');
			var fiche = terrain.data("fiche");
			maisonsToHypo[fiche.id] = fiche;
			var div = $('<div>' + fiche.nom + '</div>');
			var boutonAnnuler = $('<button style="margin-right:5px">Annuler</button>');
			boutonAnnuler.click(function(){
				addOption(fiche);
				$(this).parent().remove();
				cout-=fiche.hypotheque;
				updateCout();
				delete maisonsToHypo[fiche.id];
			});
			div.prepend(boutonAnnuler);
			$('#toHypotheque').append(div)
			$('select > option:selected','#idTerrains').remove();
			cout+=fiche.montantHypotheque;
			updateCout();
		});
		
		/* Valide le formulaire */
		function validerActions() {
		  if(totalRestant < 0){
			  alert("Opération impossible : pas assez d'argent");
			  return;
		  }
		  
		  // On verifie l'equilibre des maisons
		  var testGroups = [];
		  $('select[data-color]','#idTerrainsConstructibles').each(function(){
		    var color = $(this).get(0).dataset.color;
    		    if (testGroups[color]==null) {
			 testGroups[color] = {min:5,max:0};
		    }
		    testGroups[color].min = Math.min(testGroups[color].min,$(this).val());
		    testGroups[color].max = Math.max(testGroups[color].max,$(this).val());
		  })
		  for (var color in testGroups) {
		    if(testGroups[color].max - testGroups[color].min > 1){
			 alert("Il faut équilibrer les maisons");  
			 return;
		    }
		  }
		  // On recupere les fiches et on hypotheque les biens
		  for(var id in maisonsToHypo){
		    maisonsToHypo[id].hypotheque();
		  }
		  
		  // On recupere les fiches dont on leve l'hypotheque
		  for(var id in maisonsToLever){
		  	maisonsToLever[id].leveHypotheque();
		  }
		  
		  // Gestion des constructions
		  for (var achat in changesConstructions) {
		    var data = changesConstructions[achat];
		    data.propriete.setNbMaison(data.nbMaison);
		    joueurCourant.payer(data.cout);
		  }
		  
		  $('#housesPanel').dialog('close');
		}
		
		//DONE
		function updateCout() {
		  
		  // On mets a jour les maisons, si on ajoute, on ne peut pas hypothequer
			$('select > option[data-color]','#idTerrains').removeAttr('disabled');
		  $('select[data-color][value!=0]','#idTerrainsConstructibles').each(function(){
			var groupColor = $(this).attr('data-color');
			$('select > option[data-color="' + groupColor +'"]','#idTerrains').attr('disabled','disabled');
		  });
		  
		  // Gestion des constructions
		  var totals = {nbMaison:0,nbHotel:0,cout:0}
		  for (var achat in changesConstructions) {
		    var data = changesConstructions[achat];
		    totals.cout+=data.cout;
		    totals.nbMaison+=data.maison || 0;
		    totals.nbHotel+=data.hotel || 0;
		  }
		  $('#coutAchats > span[name]').each(function(){
		    $(this).text(totals[$(this).attr('name')]);
		  })
		  $('#idCoutTotal').text((cout-totals.cout) + " " + CURRENCY);
		  totalRestant = joueurCourant.montant+cout-totals.cout;
		  $('#idArgentRestant').text((joueurCourant.montant+cout-totals.cout) + " " + CURRENCY);		  
		}
		
		//DONE
		function addOption(fiche){
			var option = $("<option data-color='" + fiche.color + "' value='" + fiche.id + "'>" + fiche.nom + " (+" + fiche.montantHypotheque + " " + CURRENCY + ")</option>");
			option.data("fiche",fiche);			
			$('select','#idTerrains').append(option);
		}
		
		//DONE
		function addLeverHypotheque(button,fiche) {
		  button.attr('disabled','disabled');
		  cout-=Math.round(fiche.montantHypotheque*1.1);
		  maisonsToLever.push(fiche);
		  updateCout();
		}
		
		// Changement sur les constructions
		var changesConstructions = {};
		//DONE
		function loadConstructibles() {		  
		  var groups = joueurCourant.findGroupes();
		  var table = $('#idTerrainsConstructibles');
		  for (var color in groups) {
			  var divTitre = $('<div style="cursor:pointer">Groupe <span style="color:' + color + ';font-weight:bold">' + groups[color].proprietes[0].groupe + '</span></div>');
			  divTitre.data("color",color.substring(1));
			  divTitre.click(function(){
				  var c = $(this).data('color');
				  if($('div.propriete-' + c + ':visible',table).length == 0){
					  // On ouvre
					  $('div.propriete-' + c,table).slideDown();
				  }
				  else{
					  $('div.propriete-' + c,table).slideUp();
				  }
			  });			  
		    $(table).append(divTitre);
		    $(groups[color].proprietes).each(function() {
			 var propriete = this;
			  var divTerrain = $('<div class="propriete propriete-' + this.color.substring(1) + '"></div>');
			  divTerrain.append('<span style="color:' + this.color + '" class="title-propriete">' + this.nom + '</span>');
			  var select = $('<select data-color="' + this.color + '" class="' + ((this.nbMaison==5)?'hotel':'maison') + '"></select>');
			 for (var j = 0; j <= ((false) ? this.nbMaison : 5); j++) {
				select.append("<option class=\"" + ((j==5)?"hotel":"maison") + "\" value=\"" + j + "\" " + ((this.nbMaison == j) ? "selected" : "") + ">x " + ((j==5)?1:j) + "</option>");
			 }
			 select.change(function(){
				// On verifie changement par rapport a l'origine
				if (propriete.nbMaison == $(this).val()) {
				  delete changesConstructions[propriete.id];
				  $('~span',this).text("");
				  updateCout();
				  return;
				}
				var data = ($(this).val() == 5)?{hotel:1}:{maison:$(this).val() - propriete.nbMaison};
				data.propriete = propriete;
				data.nbMaison = $(this).val();
				data.cout = ($(this).val() > propriete.nbMaison)
				  ?($(this).val()-propriete.nbMaison)*propriete.prixMaison
				  :($(this).val()-propriete.nbMaison )*propriete.prixMaison/2;
				  $(this).removeClass().addClass(($(this).val()==5)?'hotel':'maison');
				$('~span',this).text(data.cout);
				changesConstructions[propriete.id] = data;
				updateCout();
			 });
			 divTerrain.append(select).append('<span></span> ' + CURRENCY);
			 
			 $(table).append(divTerrain);
		    });
		  }
		}
		//DONE
		function loadHypothecables() {
		  var proprietes = joueurCourant.findMaisonsHypothecables();
		  $(proprietes).each(function(){
			  addOption(this);
		  });
		}
		// DONE
		function loadHypotheques() {
		  var proprietes = joueurCourant.findMaisonsHypothequees();
		  $(proprietes).each(function(){
			  var fiche = this;
			  var div = $("<div>" + this.nom + "</div>");
			 var boutonLever = $('<button style="margin-right:5px">Lever</button>');
			  boutonLever.click(function(){
				  addLeverHypotheque($(this),fiche);
			  });
			  div.prepend(boutonLever);
			   $('#idTerrainsHypotheques > div').append(div);
		  });
		}
		// DONE
		function loadPanel(args) {
		  reset();
		  loadHypothecables();
		  loadHypotheques();
		  loadConstructibles();										  
		}
		
		$('#housesPanel').dialog({
			width:800,
			height:600,
			title:'Gestion des maisons',
			modal:true,
			buttons:{'Fermer':function(){$('#housesPanel').dialog('close');},"Valider":validerActions},
			autoOpen:false,
			open:function(){
				// On charge les proprietes a hypothequer
				loadPanel();
			}			
		});
		
	   </script>
	 
	 	 
		</body>
    </html>
